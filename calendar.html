<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimaID - Calendar</title>
    <link rel="stylesheet" href="src/css/output.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading calendar...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">

        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-circle text-blue-600 text-2xl"></i>
                        <h1 class="text-2xl font-bold text-gray-900">AnimaID</h1>
                    </div>

                    <div class="flex items-center space-x-4">
                        <a href="dashboard.html" class="text-gray-600 hover:text-blue-600 transition-colors">
                            <i class="fas fa-arrow-left mr-1"></i>Back to Dashboard
                        </a>
                        <button id="logout-btn" class="text-gray-600 hover:text-gray-900 transition-colors">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <!-- Page Header -->
            <div class="mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Calendar</h2>
                        <p class="text-gray-600 mt-1">Manage events, activities, and schedules</p>
                    </div>
                    <button id="add-event-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Event
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="published">Published</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div>
                        <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Types</option>
                            <option value="activity">Activity</option>
                            <option value="event">Event</option>
                            <option value="shift">Shift</option>
                            <option value="maintenance">Maintenance</option>
                        </select>
                    </div>
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input
                            type="date"
                            id="start-date"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>
                    <div class="flex items-end">
                        <button id="filter-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors mr-2">
                            <i class="fas fa-filter mr-2"></i>Filter
                        </button>
                        <button id="clear-filters-btn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Events List -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Events</h3>
                </div>

                <div class="divide-y divide-gray-200" id="events-list">
                    <!-- Events will be loaded here -->
                </div>

                <!-- Pagination -->
                <div id="pagination" class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing <span id="showing-from">1</span> to <span id="showing-to">10</span> of <span id="total-events">0</span> events
                    </div>
                    <div class="flex space-x-2">
                        <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-chevron-left mr-1"></i>Previous
                        </button>
                        <button id="next-page" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Next<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="modal-title" class="text-lg font-semibold text-gray-900">Add New Event</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="event-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                            <input
                                type="text"
                                id="title"
                                name="title"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                        <div>
                            <label for="event-type" class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                            <select
                                id="event-type"
                                name="event_type"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                                <option value="activity">Activity</option>
                                <option value="event">Event</option>
                                <option value="shift">Shift</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea
                            id="description"
                            name="description"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        ></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date *</label>
                            <input
                                type="date"
                                id="start-date"
                                name="start_date"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date *</label>
                            <input
                                type="date"
                                id="end-date"
                                name="end_date"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="start-time" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                            <input
                                type="time"
                                id="start-time"
                                name="start_time"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                        <div>
                            <label for="end-time" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                            <input
                                type="time"
                                id="end-time"
                                name="end_time"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                            <input
                                type="text"
                                id="location"
                                name="location"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                        <div>
                            <label for="max-participants" class="block text-sm font-medium text-gray-700 mb-1">Max Participants</label>
                            <input
                                type="number"
                                id="max-participants"
                                name="max_participants"
                                min="1"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="age-min" class="block text-sm font-medium text-gray-700 mb-1">Min Age</label>
                            <input
                                type="number"
                                id="age-min"
                                name="age_min"
                                min="0"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                        <div>
                            <label for="age-max" class="block text-sm font-medium text-gray-700 mb-1">Max Age</label>
                            <input
                                type="number"
                                id="age-max"
                                name="age_max"
                                min="0"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select
                                id="status"
                                name="status"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                                <option value="draft">Draft</option>
                                <option value="published">Published</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center">
                        <input
                            type="checkbox"
                            id="is-public"
                            name="is_public"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        >
                        <label for="is-public" class="ml-2 block text-sm text-gray-700">
                            Make this event public (visible to parents)
                        </label>
                    </div>

                    <div class="flex items-center">
                        <input
                            type="checkbox"
                            id="is-all-day"
                            name="is_all_day"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        >
                        <label for="is-all-day" class="ml-2 block text-sm text-gray-700">
                            All day event
                        </label>
                    </div>
                </form>

                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancel-btn" class="px-4 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button id="save-event-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition-colors">
                        <i class="fas fa-save mr-1"></i>Save Event
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Screen -->
    <div id="error-screen" class="hidden fixed inset-0 bg-gray-50 flex items-center justify-center">
        <div class="max-w-md w-full bg-white rounded-lg shadow-md p-8 text-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Access Denied</h3>
            <p class="text-gray-600 mb-6">You don't have permission to access the calendar.</p>
            <a href="dashboard.html" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Dashboard
            </a>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window.location.origin + '/api';

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const errorScreen = document.getElementById('error-screen');
        const eventsList = document.getElementById('events-list');
        const pagination = document.getElementById('pagination');
        const eventModal = document.getElementById('event-modal');
        const eventForm = document.getElementById('event-form');

        let currentUser = null;
        let userToken = null;
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};

        // Initialize page
        async function initPage() {
            try {
                // Check authentication
                userToken = localStorage.getItem('animaid_token');
                const userData = localStorage.getItem('animaid_user');

                if (!userToken || !userData) {
                    showErrorScreen();
                    return;
                }

                currentUser = JSON.parse(userData);

                // Verify token and check permissions
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });

                if (!response.ok) {
                    localStorage.removeItem('animaid_token');
                    localStorage.removeItem('animaid_user');
                    window.location.href = 'login.html';
                    return;
                }

                // Check if user has calendar permissions
                const hasPermission = await checkCalendarPermission();
                if (!hasPermission) {
                    showErrorScreen();
                    return;
                }

                // Load initial data
                await loadEvents();

                // Show main content
                loadingScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');

            } catch (error) {
                console.error('Page initialization error:', error);
                showErrorScreen();
            }
        }

        // Check if user has calendar permissions
        async function checkCalendarPermission() {
            try {
                const response = await fetch(`${API_BASE_URL}/calendar?page=1&limit=1`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Load events
        async function loadEvents(page = 1, filters = {}) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: 10,
                    ...filters
                });

                const response = await fetch(`${API_BASE_URL}/calendar?${params}`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });

                if (!response.ok) throw new Error('Failed to load events');

                const data = await response.json();

                displayEvents(data.events);
                updatePagination(data.pagination);

                currentPage = page;
                currentFilters = filters;

            } catch (error) {
                console.error('Error loading events:', error);
                eventsList.innerHTML = '<div class="px-6 py-4 text-center text-gray-500">Error loading events</div>';
            }
        }

        // Display events
        function displayEvents(events) {
            if (events.length === 0) {
                eventsList.innerHTML = '<div class="px-6 py-4 text-center text-gray-500">No events found</div>';
                return;
            }

            eventsList.innerHTML = events.map(event => `
                <div class="px-6 py-4 hover:bg-gray-50">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                                        <i class="fas fa-calendar-alt text-blue-600"></i>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-sm font-medium text-gray-900">${event.title}</h4>
                                    <p class="text-sm text-gray-600">${event.description || 'No description'}</p>
                                    <div class="flex items-center space-x-4 mt-1">
                                        <span class="text-xs text-gray-500">
                                            <i class="fas fa-clock mr-1"></i>
                                            ${formatDate(event.start_date)} ${event.start_time ? 'at ' + event.start_time : ''}
                                        </span>
                                        <span class="text-xs text-gray-500">
                                            <i class="fas fa-map-marker-alt mr-1"></i>
                                            ${event.location || 'No location'}
                                        </span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(event.status)}">
                                            ${event.status}
                                        </span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            ${event.event_type}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="viewEvent(${event.id})" class="text-blue-600 hover:text-blue-900 p-1">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editEvent(${event.id})" class="text-blue-600 hover:text-blue-900 p-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteEvent(${event.id})" class="text-red-600 hover:text-red-900 p-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // Get status color
        function getStatusColor(status) {
            const colors = {
                'draft': 'bg-gray-100 text-gray-800',
                'published': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800',
                'completed': 'bg-blue-100 text-blue-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        // Update pagination
        function updatePagination(paginationData) {
            document.getElementById('showing-from').textContent = ((paginationData.page - 1) * paginationData.limit) + 1;
            document.getElementById('showing-to').textContent = Math.min(paginationData.page * paginationData.limit, paginationData.total);
            document.getElementById('total-events').textContent = paginationData.total;

            document.getElementById('prev-page').disabled = paginationData.page <= 1;
            document.getElementById('next-page').disabled = paginationData.page >= paginationData.pages;

            totalPages = paginationData.pages;
        }

        // Show add event modal
        document.getElementById('add-event-btn').addEventListener('click', () => {
            document.getElementById('modal-title').textContent = 'Add New Event';
            eventForm.reset();
            eventForm.dataset.eventId = '';
            eventModal.classList.remove('hidden');
        });

        // Close modal
        document.getElementById('close-modal').addEventListener('click', () => {
            eventModal.classList.add('hidden');
        });

        document.getElementById('cancel-btn').addEventListener('click', () => {
            eventModal.classList.add('hidden');
        });

        // Save event
        document.getElementById('save-event-btn').addEventListener('click', async (e) => {
            e.preventDefault();

            const formData = new FormData(eventForm);
            const eventData = {
                title: formData.get('title'),
                description: formData.get('description'),
                event_type: formData.get('event_type'),
                start_date: formData.get('start_date'),
                end_date: formData.get('end_date'),
                start_time: formData.get('start_time') || null,
                end_time: formData.get('end_time') || null,
                is_all_day: formData.has('is_all_day'),
                location: formData.get('location'),
                max_participants: formData.get('max_participants') ? parseInt(formData.get('max_participants')) : null,
                age_min: formData.get('age_min') ? parseInt(formData.get('age_min')) : null,
                age_max: formData.get('age_max') ? parseInt(formData.get('age_max')) : null,
                status: formData.get('status'),
                is_public: formData.has('is_public')
            };

            try {
                const eventId = eventForm.dataset.eventId;
                const method = eventId ? 'PUT' : 'POST';
                const url = eventId ? `${API_BASE_URL}/calendar/${eventId}` : `${API_BASE_URL}/calendar`;

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(eventData)
                });

                const data = await response.json();

                if (response.ok) {
                    eventModal.classList.add('hidden');
                    await loadEvents(currentPage, currentFilters);
                    alert(`Event ${eventId ? 'updated' : 'created'} successfully!`);
                } else {
                    alert('Error: ' + (data.error || `Failed to ${eventId ? 'update' : 'create'} event`));
                }

            } catch (error) {
                console.error('Error saving event:', error);
                alert('Network error. Please try again.');
            }
        });

        // Filter events
        document.getElementById('filter-btn').addEventListener('click', () => {
            const filters = {
                status: document.getElementById('status-filter').value,
                event_type: document.getElementById('type-filter').value,
                start_date: document.getElementById('start-date').value
            };

            // Remove empty filters
            Object.keys(filters).forEach(key => {
                if (!filters[key]) delete filters[key];
            });

            loadEvents(1, filters);
        });

        document.getElementById('clear-filters-btn').addEventListener('click', () => {
            document.getElementById('status-filter').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('start-date').value = '';
            loadEvents(1, {});
        });

        // Pagination
        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                loadEvents(currentPage - 1, currentFilters);
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            if (currentPage < totalPages) {
                loadEvents(currentPage + 1, currentFilters);
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await fetch(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }

            localStorage.removeItem('animaid_token');
            localStorage.removeItem('animaid_user');
            window.location.href = 'login.html';
        });

        // Utility functions
        function showErrorScreen() {
            loadingScreen.classList.add('hidden');
            mainContent.classList.add('hidden');
            errorScreen.classList.remove('hidden');
        }

        // Global functions for inline event handlers
        window.viewEvent = function(eventId) {
            // For now, just show an alert. Could open a detailed view modal
            alert('View event details functionality coming soon! Event ID: ' + eventId);
        };

        window.editEvent = async function(eventId) {
            try {
                // Load event details
                const response = await fetch(`${API_BASE_URL}/calendar/${eventId}`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });

                if (!response.ok) {
                    alert('Failed to load event details');
                    return;
                }

                const data = await response.json();
                const event = data.event;

                // Populate form
                document.getElementById('modal-title').textContent = 'Edit Event';
                document.getElementById('title').value = event.title;
                document.getElementById('description').value = event.description || '';
                document.getElementById('event-type').value = event.event_type;
                document.getElementById('start-date').value = event.start_date;
                document.getElementById('end-date').value = event.end_date;
                document.getElementById('start-time').value = event.start_time || '';
                document.getElementById('end-time').value = event.end_time || '';
                document.getElementById('location').value = event.location || '';
                document.getElementById('max-participants').value = event.max_participants || '';
                document.getElementById('age-min').value = event.age_min || '';
                document.getElementById('age-max').value = event.age_max || '';
                document.getElementById('status').value = event.status;
                document.getElementById('is-public').checked = event.is_public;
                document.getElementById('is-all-day').checked = event.is_all_day;

                // Store event ID for update
                eventForm.dataset.eventId = eventId;

                // Show modal
                eventModal.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading event for edit:', error);
                alert('Failed to load event details');
            }
        };

        window.deleteEvent = async function(eventId) {
            if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/calendar/${eventId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });

                if (response.ok) {
                    await loadEvents(currentPage, currentFilters);
                    alert('Event deleted successfully!');
                } else {
                    alert('Failed to delete event');
                }

            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Network error. Please try again.');
            }
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initPage);
    </script>

</body>
</html>
